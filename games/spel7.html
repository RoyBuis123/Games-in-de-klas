<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Physics Stunt Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { font-family: 'Inter', sans-serif; }
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
      .text-shadow { text-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
      .text-shadow-md { text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
      @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
      }
      .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>

    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@^19.2.3",
          "react/": "https://esm.sh/react@^19.2.3/"
        }
      }
    </script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useCallback, useRef } = React;

      function sendScoreToPlatform(score100) {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('game');
        const gameNum = raw !== null && raw !== '' ? Number(raw) : null;

        const safeScore = Math.max(0, Math.min(100, Math.round(Number(score100) || 0)));

        window.parent.postMessage(
          { type: 'GAME_SCORE', gameNum: Number.isFinite(gameNum) ? gameNum : null, score: safeScore },
          window.location.origin
        );
      }

      const Lives = ({ count }) => {
        const INITIAL_LIVES = 3;
        return (
          <div className="flex items-center space-x-2">
            <span className="text-lg font-bold text-slate-700">Lives:</span>
            <div className="flex space-x-1">
              {[...Array(INITIAL_LIVES)].map((_, i) => (
                 <i key={i} className={`fa-solid fa-heart text-2xl ${i < count ? 'text-red-500' : 'text-slate-300'}`} />
              ))}
            </div>
          </div>
        );
      };

      const Car = () => (
        <div className="relative w-12 h-8">
          <div className="absolute bottom-2 left-0 w-full h-5 bg-red-500 rounded-t-md border-2 border-red-800" />
          <div className="absolute bottom-7 left-2 w-8 h-3 bg-red-400 rounded-t-sm border-2 border-red-800" />
          <div className="absolute bottom-0 left-1 w-4 h-4 bg-gray-700 rounded-full border-2 border-gray-800" />
          <div className="absolute bottom-0 right-1 w-4 h-4 bg-gray-700 rounded-full border-2 border-gray-800" />
        </div>
      );

      const Diagram = ({ angle, inclineLength, isAnimating = false }) => {
        const rampLength = 400;
        const carWidth = 48;
        const travelDistance = rampLength - carWidth;

        const pixelsPerMeter = rampLength / inclineLength;

        const angleInRadians = angle * (Math.PI / 180);
        const rampHeight = rampLength * Math.sin(angleInRadians);
        const rampWidth = rampLength * Math.cos(angleInRadians);

        return (
          <div className="w-full h-64 flex items-end justify-center mb-4 relative" aria-hidden="true">
            <div className="relative" style={{ width: `${rampLength}px`, height: '200px' }}>
              <div
                className="absolute bottom-0 left-0 transition-transform duration-300 ease-out"
                style={{
                  transform: `rotate(${-angle}deg)`,
                  transformOrigin: 'bottom left',
                }}
              >
                <div className="bg-slate-500 w-[400px] h-3 rounded-full shadow-inner" />

                <div
                  className="absolute"
                  style={{
                    left: '0px',
                    bottom: '6px',
                    transition: isAnimating ? 'transform 1.5s ease-in' : 'none',
                    transform: isAnimating ? `translateX(${travelDistance}px)` : `translateX(0px)`,
                  }}
                >
                  <Car />
                </div>
              </div>

              <div className="absolute bottom-0 left-0 w-full h-1.5 bg-slate-600" />
              <div
                className="absolute bottom-0 left-0 w-24 h-24 border-l-2 border-b-2 border-dashed border-white/70 rounded-bl-full"
                style={{ transform: 'translateY(1px)'}}
              />
              <div className="absolute bottom-2 left-8 text-white font-semibold text-lg text-shadow">
                {angle.toFixed(0)}Â°
              </div>

              {angle > 2 && (
                <>
                  <div
                    className="absolute bottom-0 border-r-2 border-dashed border-white/70 transition-all duration-300 ease-out"
                    style={{
                      left: `${rampWidth}px`,
                      height: `${rampHeight}px`,
                    }}
                  />
                  <div
                    className="absolute text-white font-semibold transition-all duration-300 ease-out text-shadow"
                    style={{
                      bottom: `${rampHeight / 2 - 10}px`,
                      left: `${rampWidth + 10}px`,
                    }}
                  >
                    {(rampHeight / pixelsPerMeter).toFixed(1)} m
                  </div>
                </>
              )}
            </div>
          </div>
        );
      };

      const StartScreen = ({ onStart }) => {
        return (
          <div className="text-center z-10">
            <h1 className="text-5xl font-bold text-white mb-4 text-shadow-md">Stunt Challenge!</h1>
            <p className="text-lg text-sky-100 mb-2 max-w-2xl text-shadow">
              You are a rookie stunt designer. Your mission is to calculate the physics for a daring car jump.
            </p>
            <p className="text-lg text-sky-100 mb-8 max-w-2xl text-shadow">
              Observe the car's run down the ramp to find the time and distance, then calculate the final speed.
            </p>
            <p className="text-lg text-sky-100 mb-8 max-w-2xl text-shadow font-bold">
              <code className="bg-black/20 px-2 py-1 rounded">speed = distance / time</code>
            </p>
            <button onClick={onStart} className="bg-white text-sky-600 font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-100 transition-transform transform hover:scale-105">
              Start Challenge
            </button>
          </div>
        );
      };

      const EndScreen = ({ onRestart, didWin, score }) => {
        const WinScreen = () => (
          <div className="text-center z-10">
            <h1 className="text-5xl font-bold text-white mb-4 text-shadow-md">Stunt Successful!</h1>
            <p className="text-xl text-green-200 mb-4 text-shadow">Incredible work! Your calculations were perfect and the stunt was a masterpiece.</p>
            <p className="text-lg text-sky-100 mb-8 text-shadow">Score: <span className="font-bold">{score}</span> / 100</p>
            <button onClick={onRestart} className="bg-sky-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-600 transition-transform transform hover:scale-105">
              Design Another Stunt
            </button>
          </div>
        );

        const LoseScreen = () => (
          <div className="text-center z-10">
            <h1 className="text-5xl font-bold text-white mb-4 text-shadow-md">Stunt Failed!</h1>
            <p className="text-xl text-red-200 mb-4 text-shadow">Your calculations were off. Back to the drawing board!</p>
            <p className="text-lg text-sky-100 mb-8 text-shadow">Score: <span className="font-bold">{score}</span> / 100</p>
            <button onClick={onRestart} className="bg-sky-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-600 transition-transform transform hover:scale-105">
              Try Again
            </button>
          </div>
        );

        return didWin ? <WinScreen /> : <LoseScreen />;
      };

      const round = (num, decimals) => {
        const factor = Math.pow(10, decimals);
        return Math.round(num * factor) / factor;
      };

      const TIME_LIMIT = 20;
      const QUESTIONS_TO_WIN = 3;
      const INITIAL_LIVES = 3;

      const GameScreen = ({ onGameEnd }) => {
        const [lives, setLives] = useState(INITIAL_LIVES);
        const [questionNumber, setQuestionNumber] = useState(0);
        const [status, setStatus] = useState('idle');
        const [userInput, setUserInput] = useState('');
        const [feedback, setFeedback] = useState(null);
        const [isShaking, setIsShaking] = useState(false);

        const countdownIntervalRef = useRef(null);

        const generateLevelData = useCallback(() => {
          const angle = Math.floor(Math.random() * 20) + 15;
          const distance = round(Math.random() * 5 + 5, 1);
          const time = round(distance / (angle * 0.15 + 1), 2);
          const speed = round(distance / time, 2);
          return { angle, distance, time, speed };
        }, []);

        const [levelData, setLevelData] = useState(generateLevelData);

        const scoreNow = useCallback((qNum) => {
          const step = 100 / QUESTIONS_TO_WIN;
          const rawScore = qNum * step;
          return Math.max(0, Math.min(100, Math.round(rawScore)));
        }, []);

        useEffect(() => {
          if (lives <= 0) {
            const finalScore = scoreNow(questionNumber);
            setTimeout(() => onGameEnd(false, finalScore), 700);
          }
        }, [lives, onGameEnd, questionNumber, scoreNow]);

        const handleIncorrectAnswer = useCallback((message) => {
          setFeedback({ message, type: 'incorrect' });
          setIsShaking(true);
          const newLives = lives - 1;
          setLives(newLives);
          setStatus('feedback');

          if (newLives > 0) {
            setTimeout(() => {
              setStatus('question');
              setUserInput('');
              setFeedback(null);
              setIsShaking(false);
            }, 2000);
          }
        }, [lives]);

        useEffect(() => {
          if (status === 'question') {
            let timeLeft = TIME_LIMIT;
            countdownIntervalRef.current = window.setInterval(() => {
              timeLeft -= 1;
              if (timeLeft <= 0) {
                if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);
                handleIncorrectAnswer('Time is up!');
              }
            }, 1000);
          } else {
            if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);
          }
          return () => {
            if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);
          };
        }, [status, handleIncorrectAnswer]);

        const resetForNextQuestion = useCallback(() => {
          setLevelData(generateLevelData());
          setStatus('idle');
          setUserInput('');
          setFeedback(null);
          setIsShaking(false);
        }, [generateLevelData]);

        const handleStartAnimation = () => {
          setStatus('animating');
          setTimeout(() => {
            setStatus('question');
          }, 1500);
        };

        const handleCheckAnswer = (e) => {
          e.preventDefault();
          if (status !== 'question' || feedback) return;
          if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);

          const userAnswer = parseFloat(userInput.replace(',', '.'));
          if (isNaN(userAnswer)) {
            setFeedback({ message: 'Please enter a valid number.', type: 'incorrect' });
            setTimeout(() => setFeedback(null), 2000);
            return;
          }

          const isCorrect = Math.abs(userAnswer - levelData.speed) < 0.05;

          if (isCorrect) {
            const newQuestionNumber = questionNumber + 1;
            setQuestionNumber(newQuestionNumber);
            setFeedback({ message: 'Perfect Calculation!', type: 'correct' });
            setStatus('feedback');

            const currentScore = scoreNow(newQuestionNumber);

            if (newQuestionNumber >= QUESTIONS_TO_WIN) {
              setTimeout(() => onGameEnd(true, 100), 700);
            } else {
              setTimeout(resetForNextQuestion, 1500);
            }
          } else {
            handleIncorrectAnswer(`Not quite. The correct answer was ${levelData.speed.toFixed(2)} m/s.`);
          }
        };

        const StatusBar = () => (
          <div className="w-full flex justify-between items-center bg-white/70 backdrop-blur-sm p-3 rounded-t-2xl shadow-md mb-[-1px] z-10">
            <Lives count={lives} />
            <div className="text-lg font-bold text-slate-700">
              Calculation: <span className="text-sky-600">{questionNumber + 1} / {QUESTIONS_TO_WIN}</span>
            </div>
          </div>
        );

        return (
          <div className="w-full h-full flex flex-col items-center">
            <StatusBar />
            <Diagram
              angle={levelData.angle}
              inclineLength={levelData.distance}
              isAnimating={status === 'animating'}
            />
            <div className="w-full max-w-md flex flex-col items-center p-6 rounded-xl bg-black/20 backdrop-blur-sm shadow-lg">
              {status === 'idle' && (
                <div className="text-center">
                  <p className="text-md text-white text-shadow mb-4">
                    The car will travel <span className="font-bold">{levelData.distance} meters</span>. Start the run to see how long it takes.
                  </p>
                  <button onClick={handleStartAnimation} className="bg-white text-sky-600 font-bold py-2 px-6 rounded-lg text-lg hover:bg-sky-100 transition">
                    Start Run
                  </button>
                </div>
              )}

              {status === 'animating' && (
                <div className="text-center">
                  <p className="text-lg text-white text-shadow">Measuring time...</p>
                  <div className="text-4xl font-mono font-bold text-white mt-2" role="status">...</div>
                </div>
              )}

              {(status === 'question' || status === 'feedback') && (
                <div className="w-full">
                  <div className="grid grid-cols-2 gap-4 mb-4 text-xl">
                    <div className="p-3 bg-sky-100/20 rounded-md text-center">
                      <div className="text-sm text-sky-200 font-semibold">DISTANCE</div>
                      <div className="text-2xl text-white font-bold">{levelData.distance} m</div>
                    </div>
                    <div className="p-3 bg-sky-100/20 rounded-md text-center">
                      <div className="text-sm text-sky-200 font-semibold">TIME</div>
                      <div className="text-2xl text-white font-bold">{levelData.time} s</div>
                    </div>
                  </div>

                  <form onSubmit={handleCheckAnswer} className="w-full">
                    <label htmlFor="speed-input" className="block text-center text-md font-medium text-white mb-2 text-shadow">
                      What is the average speed in m/s?
                      <br />
                      <span className="text-sm text-sky-200">(Round to 2 decimal places)</span>
                    </label>
                    <div className={`flex items-center gap-4 ${isShaking ? 'shake' : ''}`}>
                      <input
                        id="speed-input"
                        type="number"
                        step="0.01"
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        className="flex-grow w-full p-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition text-center text-xl"
                        placeholder="0.00"
                        disabled={status === 'feedback'}
                        autoFocus
                      />
                      <span className="text-xl font-bold text-white text-shadow">m/s</span>
                    </div>
                    <button
                      type="submit"
                      className="w-full mt-6 bg-white text-sky-600 font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-100 transition-transform transform hover:scale-105 disabled:bg-slate-400/50 disabled:text-white disabled:cursor-not-allowed disabled:scale-100"
                      disabled={!userInput || status === 'feedback'}
                    >
                      Check Calculation
                    </button>
                  </form>
                </div>
              )}

              {status === 'feedback' && feedback && (
                <div className="text-center mt-4 animate-fade-in h-12">
                  <p className={`text-xl font-bold text-shadow ${feedback.type === 'correct' ? 'text-green-300' : 'text-red-300'}`}>
                    {feedback.message}
                  </p>
                </div>
              )}
            </div>
          </div>
        );
      };

      const App = () => {
        const [gameState, setGameState] = useState('start');
        const [finalScore, setFinalScore] = useState(0);

        const sentRef = useRef(false);

        const handleStart = () => {
          sentRef.current = false;
          setFinalScore(0);
          setGameState('playing');
        };

        const handleGameEnd = (win, score) => {
          const safeScore = Math.max(0, Math.min(100, Math.round(Number(score) || 0)));
          setFinalScore(safeScore);

          if (!sentRef.current) {
            sentRef.current = true;
            sendScoreToPlatform(safeScore);
          }

          setGameState(win ? 'completed' : 'gameOver');
        };

        const handleRestart = () => {
          setGameState('start');
        };

        const renderContent = () => {
          switch (gameState) {
            case 'start':
              return <StartScreen onStart={handleStart} />;
            case 'playing':
              return <GameScreen onGameEnd={handleGameEnd} />;
            case 'completed':
              return <EndScreen onRestart={handleRestart} didWin={true} score={finalScore} />;
            case 'gameOver':
              return <EndScreen onRestart={handleRestart} didWin={false} score={finalScore} />;
            default:
              return <StartScreen onStart={handleStart} />;
          }
        };

        return (
          <div className="min-h-screen w-screen bg-slate-200 flex flex-col items-center justify-center p-4 font-sans text-slate-800">
            <main className="w-full max-w-4xl bg-gradient-to-b from-sky-400 to-sky-600 rounded-2xl shadow-xl p-6 md:p-10 flex flex-col items-center justify-center min-h-[700px] relative overflow-hidden">
              <div className="absolute top-8 right-12 w-20 h-20 bg-yellow-300 rounded-full shadow-lg animate-pulse" />
              <div className="absolute -bottom-16 -left-16 w-48 h-48 bg-white/10 rounded-full" />
              {renderContent()}
            </main>
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);
    </script>
  </body>
</html>
